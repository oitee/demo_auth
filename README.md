# octopus
Simple demonstration of logging in by using OAuth 2.0 with Google's authentication server. It is deployed here: [https://octopus.otee.dev/](https://octopus.otee.dev/). It does just one thing: **allows users to log-in using their Google accounts**. If successful, the profile photo and name of the user is displayed.

<p align="center">
<img src="https://otee.dev/assets/images/oAuth_10.png" alt="Successful log-in, using Google's OAuth framework" border="1px" width="30%"/>
</p>

### Goal

The goal of this project: to leverage Google’s authorization server, to

- **Authenticate users**: By doing this, we do not need to maintain a database to store users of the application (and their credentials) 
- **Access users’ information from Google**: Using OAuth, we can access necessary information of users from the relevant resource server

Once access tokens and refresh tokens are generated, they are sent back to the user, as cookies. Thus, for subsequent requests by the same user, we rely on their cookies, to make requests with Google's API.

### Running octopus

To run this project locally, you first need to obtain credentials of your application (client id and client secret), by visiting the ‘Credentials’ tab on the [Google API Console](https://console.developers.google.com/?authuser=0).

```bash
npm install
CLIENT_ID=XXX CLIENT_SECRET=XXX PORT=4000 DOMAIN=http://localhost:4000 node server.js

```



### Key Steps

Here is a brief walk-through of the steps that enables [`octopus`](https://octopus.otee.dev/) to access Google APIs by using OAuth 2.0:

#### Obtain Client Credentials

First, we must register our client application and generate the client ID and client secret. This is done by visiting the ‘Credentials’ tab on the [Google API Console](https://console.developers.google.com/?authuser=0). We also set the redirect URL(s) of our app.

#### Create an Authorization Request

The next step is to create an authorization request. The authorization end-point for Google’s authorization server is: [`https://accounts.google.com/o/oauth2/v2/auth`](https://accounts.google.com/o/oauth2/v2/auth). The request sent to this end-point should contain certain parameters (called ‘authorization parameters’), that can identify the client application (using the Client ID), specify the redirect URL, the scope of access etc.

#### Redirect the User to the Authorization End-Point

When the user needs to log-in, our app will redirect the user to the authorization end-point, by sending the authorization request created above. Here’s the authorization request created by `octopus`:

```
https://accounts.google.com/o/oauth2/v2/auth?
client_id=358241736286-fopbu1q67d0v4gdrlntshii0j30nh9jb.apps.googleusercontent.com&
redirect_uri=https://octopus.otee.dev/callBack&
scope=https://www.googleapis.com/auth/userinfo.profile&
response_type=code&
prompt=consent&
access_type=offline
```

#### Google Seeks User Consent

Once Google’s authorization server receives the authorization request, it authenticates the user and displays a consent window showing the name of the application and the scopes of access requested. Here’s the consent window displayed for [`octopus`](https://octopus.otee.dev/):

<p align="center">
<img src="https://otee.dev/assets/images/oAuth_11.png" alt="Consent Window" width="50%"/>
</p>

#### Redirection to Client’s Redirect URL 

Once the user provides their consent, the authorization server redirects the user to the redirect URL of our app along with the authorization code. Here’s how the request to the redirection endpoint is generated by the authorization server:

```
https://octopus.otee.dev/callBack?
code=XXX&
scope=profile+https://www.googleapis.com/auth/userinfo.profile
```

#### Request for Access Tokens

Once our app receives the authorization code (at the redirection URL), it generates a request to the token end-point of the authorization server, namely [`https://oauth2.googleapis.com/token`](https://oauth2.googleapis.com/token). This should be a `POST` request accompanied with certain parameters that authenticates our app (client ID and client secret), discloses the authorization code, specifies the redirect URL, etc. Here’s how the [`octopus`](https://octopus.otee.dev/) generates a request for receiving access tokens:

```js
/**
Values of the following variables are accessed using environment variables:
baseUrl (i.e., the domain name of the app)
clientID (i.e., the client ID of the app)
client_secret (i.e., the client secret of the app)
redirect_url (i.e., the redirect URL of the app)

Also, the variable ‘code’ carries the value of the authorization code received from the authorization server.
*/

const grant = "authorization_code";
const redirect_uri = `${baseUrl}/callBack`;
const params = new URLSearchParams();

params.append("client_id", clientID);
params.append("client_secret", client_secret);
params.append("code", code);
params.append("grant_type", grant);
params.append("redirect_uri", redirect_uri);
const tokens = await fetch("https://oauth2.googleapis.com/token", {
method: "post",
body: params,
}).then((res) => res.json());
```

#### Response with Access and Refresh Tokens

Google’s Authorization server responds with a JSON containing access and refresh tokens. Here’s an example of a JSON returned by the Authorization server:

```
{
access_token: 'XX',
expires_in: 3599,
refresh_token: 'XXXXX',
scope: 'https://www.googleapis.com/auth/userinfo.profile',
token_type: 'Bearer',
}
```

#### Making API Calls

Now that we have the access token, we can make requests with Google’s resource server which hosts the resource we need. In the case of [`octopus`](https://octopus.otee.dev/), the resource server end-point is [`https://www.googleapis.com/oauth2/v3/userinfo?alt=json`](https://www.googleapis.com/oauth2/v3/userinfo?alt=json). When we send a request with valid tokens, we get a response payload carrying essential details about the user:

```
{
id: '104...',
name: 'Oitihjya Sen',
given_name: 'Oitihjya',
family_name: 'Sen',
picture: 'https://lh3.googleusercontent.com/a-/AOh14GgD6lcmhewdz51x-t-uJACtZu8HstvP6csiBrRhBA=s96-c',
locale: 'en'
}
```

Using this response, we can display the user’s name and image:

<p align="center">
<img src="https://otee.dev/assets/images/oAuth_10.png" alt="Successful log-in, using Google's OAuth framework" border="1px" width="60%"/>
</p>

Here's a sequence diagram summarising the key steps:

<p align="center">
<img src="https://otee.dev/assets/images/oAuth_9.png" alt="Using OAuth to make Google API calls" width="120%"/>
</p>
